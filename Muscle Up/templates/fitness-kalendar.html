<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src *;">
    <link rel="stylesheet" href="{{ url_for('static', filename='nav.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Muscle Up | Fitness-Kalender</title>
</head>
<body>
    <div class="wrapper">
        <header class="head">
            <h1 class="headline">Fitness-Kalender</h1>
            <div class="nav-bar">
                 <!-- Links: Logo -->
                <h1 class="headline">Muscle Up</h1>

                <!-- Mitte: Navigation (nur Desktop) -->
                <nav class="nav-top">
                    <a href="{{ url_for('index') }}" class="link">Home</a>
                    <a href="{{ url_for('workout_page') }}" class="link">Training</a>
                </nav>

        <!-- Rechts: Userbereich / Login -->
        {% if 'user_id' in session %}
        <div class="nav-user">
            <div class="dropdown">
                <button class="dropbtn">
                    <img src="{{ current_user_profile.profile_pic_url if current_user_profile else url_for('static', filename='profile_pics/default.png') }}" 
     alt="Profil" class="profile-pic"
     onerror="this.src='{{ url_for('static', filename='profile_pics/default.png') }}'">
                </button>
                <div class="dropdown-content">
                    <span class="username">{{ session['username'] }}</span>
                    <a href="{{ url_for('profile') }}">Mein Profil</a>
                    <a href="{{ url_for('logout') }}">Logout</a>
                </div>
            </div>
        </div>
        {% else %}
        <nav class="nav-top">
            <a href="{{ url_for('login') }}">Login</a>
            <a href="{{ url_for('register') }}">Registrieren</a>
        </nav>
        {% endif %}

        <!-- Hamburger Button (nur Mobile) -->
        <button class="hamburger" onclick="toggleMenu()">‚ò∞</button>
    </div>

    <!-- Mobile Men√º -->
    <nav class="mobile-menu" id="mobileMenu">
        <a href="{{ url_for('index') }}">Start</a>

        {% if 'user_id' in session %}
            <a href="{{ url_for('profile') }}">Mein Profil</a>
            <a href="{{ url_for('workout_page') }}">Training</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
            <a href="{{ url_for('login') }}">Login</a>
            <a href="{{ url_for('register') }}">Registrieren</a>
        {% endif %}
    </nav>
</header>

        <main class="content">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="month-nav-btn" onclick="prevMonth()">
                        &lsaquo;
                    </button>
                    <h2 id="currentMonthYear"></h2>
                    <button class="month-nav-btn" onclick="nextMonth()">
                        &rsaquo;
                    </button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <div class="weekday">So</div>
                    <div class="weekday">Mo</div>
                    <div class="weekday">Di</div>
                    <div class="weekday">Mi</div>
                    <div class="weekday">Do</div>
                    <div class="weekday">Fr</div>
                    <div class="weekday">Sa</div>
                </div>
            </div>
        </main>

        <footer>
            &copy; 2024 Muscle Up | <a href="#" class="link">Impressum</a>
        </footer>
    </div>

<script>
    const workoutsData = {{ workouts | tojson }};
    const headerElement = document.querySelector('header.head');

    function generateCalendar(year, month) {
        const grid = document.getElementById('calendarGrid');
        const monthYearHeader = document.getElementById('currentMonthYear');
        
        // Monat- und Jahr-Header aktualisieren
        const date = new Date(year, month - 1);
        monthYearHeader.textContent = date.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });

        // Kalender-Grid leeren, aber Wochentage behalten
        while (grid.children.length > 7) {
            grid.removeChild(grid.lastChild);
        }

        const firstDay = new Date(year, month - 1, 1).getDay();
        const daysInMonth = new Date(year, month, 0).getDate();

        // Leere Zellen f√ºr den Start des Monats hinzuf√ºgen
        const startDayIndex = firstDay === 0 ? 6 : firstDay - 1; // Sonntag als letzter Tag
        for (let i = 0; i < startDayIndex; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.classList.add('calendar-day', 'inactive');
            grid.appendChild(dayDiv);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.classList.add('calendar-day');

            const dayNumber = document.createElement('div');
            dayNumber.classList.add('day-number');
            dayNumber.textContent = i;
            dayDiv.appendChild(dayNumber);

            const workoutSummary = document.createElement('div');
            workoutSummary.classList.add('workout-summary');
            dayDiv.appendChild(workoutSummary);

            const dateString = `${String(i).padStart(2, '0')}.${String(month).padStart(2, '0')}.${year}`;
            const workoutsForDay = workoutsData[dateString] || [];
            
            if (workoutsForDay.length > 0) {
                workoutsForDay.forEach(workout => {
                    const workoutItem = document.createElement('div');
                    workoutItem.classList.add('workout-item-mini', workout.type);
                    
                    let icon = '';
                    if (workout.type === 'calestenics') {
                        icon = 'üí™';
                    } else if (workout.type === 'cardio') {
                        icon = 'üèÉ';
                    } else if (workout.type === 'strength') {
                        icon = 'üèãÔ∏è';
                    } else if (workout.type === 'restday') {
                        icon = 'üõå';
                    }
                    
                    workoutItem.innerHTML = `<span class="workout-icon">${icon}</span> ${workout.exercise}`;
                    workoutSummary.appendChild(workoutItem);
                });
            } else {
                const emptyText = document.createElement('div');
                emptyText.classList.add('empty-day');
                emptyText.textContent = 'Keine Workouts';
                workoutSummary.appendChild(emptyText);
            }

            // Klick-Event f√ºr Workout-Details
            dayDiv.addEventListener('click', () => showWorkoutDetails(dateString, workoutsForDay));

            grid.appendChild(dayDiv);
        }

        // Leere Zellen am Ende hinzuf√ºgen
        const totalCells = startDayIndex + daysInMonth;
        const remainingCells = 42 - totalCells;
        if (totalCells <= 35) {
            for (let i = 0; i < (35 - totalCells); i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day', 'inactive');
                grid.appendChild(dayDiv);
            }
        }
    }

    function toggleHeaderVisibility(visible) {
        if (visible) {
            headerElement.classList.remove('hidden-header');
        } else {
            headerElement.classList.add('hidden-header');
        }
    }

    function showWorkoutDetails(date, workouts) {
        toggleHeaderVisibility(false); // Versteckt die Navigationsleiste
        const detailsOverlay = document.createElement('div');
        detailsOverlay.classList.add('workout-details-overlay');
        
        const detailsModal = document.createElement('div');
        detailsModal.classList.add('workout-details-modal');
        
        let detailsHtml = `
        <div class="workout-details-header">
            <h3 class="workout-details-title">Workouts am ${date}</h3>
            <button class="close-btn" onclick="hideWorkoutDetails()">&times;</button>
        </div>
        <div class="workout-list">`;
        
        if (workouts.length > 0) {
            workouts.forEach(w => {
                detailsHtml += `
                <div class="workout-item-full ${w.type}">
                    <div class="workout-item-header">
                        <span class="workout-type ${w.type}">
                            ${w.type === 'calestenics' ? 'üí™ Calisthenics' : 
                              w.type === 'cardio' ? 'üèÉ Cardio' : 
                              w.type === 'strength' ? 'üèãÔ∏è Krafttraining' :
                              w.type === 'restday' ? 'üõå Ruhetag' : w.type}
                        </span>
                        <form method="post" action="/delete_workout_from_calendar/${w.id}" class="delete-workout-form">
                            <button type="submit" class="delete-btn-small">L√∂schen</button>
                        </form>
                    </div>
                    <div class="workout-details-text">${w.exercise}</div>
                    <ul class="workout-sets">`;
                
                if (w.type === 'cardio') {
                    detailsHtml += `<li class="set-item">Dauer: ${w.duration} Min, Distanz: ${w.distance} Km</li>`;
                } else if (w.sets) {
                    w.sets.forEach(s => {
                        detailsHtml += `<li class="set-item">${s.reps} Wiederholungen ${s.weight ? ' | ' + s.weight + 'kg' : ''}</li>`;
                    });
                }
                
                detailsHtml += `
                    </ul>
                </div>`;
            });
        } else {
            detailsHtml += `<div class="empty-workout">Keine Workouts an diesem Tag</div>`;
        }
        
        detailsHtml += `</div>`;
        
        detailsModal.innerHTML = detailsHtml;
        detailsOverlay.appendChild(detailsModal);
        document.body.appendChild(detailsOverlay);
        
        // Event-Listener f√ºr L√∂sch-Buttons hinzuf√ºgen
        const deleteForms = detailsModal.querySelectorAll('.delete-workout-form');
        deleteForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                if (confirm('M√∂chtest du dieses Workout wirklich l√∂schen?')) {
                    this.submit();
                }
            });
        });
    }
    
    function hideWorkoutDetails() {
        toggleHeaderVisibility(true); // Zeigt die Navigationsleiste wieder an
        const detailsOverlay = document.querySelector('.workout-details-overlay');
        if (detailsOverlay) {
            detailsOverlay.remove();
        }
    }

    let currentYear, currentMonth;
    
    function updateDate() {
        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth() + 1;
        generateCalendar(currentYear, currentMonth);
    }

    function prevMonth() {
        currentMonth--;
        if (currentMonth < 1) {
            currentMonth = 12;
            currentYear--;
        }
        generateCalendar(currentYear, currentMonth);
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 12) {
            currentMonth = 1;
            currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
    }

    function toggleMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        mobileMenu.classList.toggle('active');
    }

    document.addEventListener('DOMContentLoaded', updateDate);
</script>
</body>
</html>